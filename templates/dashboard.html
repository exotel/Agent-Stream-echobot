<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🤖 AgentStream Dashboard - Live Monitoring</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .stat-card {
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .event-item {
            animation: slideIn 0.3s ease-in;
            border-left: 4px solid;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .event-item:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .event-connected { border-left-color: #28a745; }
        .event-start { border-left-color: #007bff; }
        .event-media { border-left-color: #17a2b8; }
        .event-mark { border-left-color: #ffc107; }
        .event-mark_response { border-left-color: #28a745; }
        .event-clear { border-left-color: #fd7e14; }
        .event-clear_response { border-left-color: #28a745; }
        .event-dtmf { border-left-color: #6f42c1; }
        .event-dtmf_response { border-left-color: #28a745; }
        .event-stop { border-left-color: #dc3545; }
        .event-call_info { border-left-color: #6c757d; }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .navbar-brand { font-weight: bold; }
        .card-header { font-weight: 600; }
        
        .event-feed {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .call-history {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .call-sessions {
            max-height: 350px;
            overflow-y: auto;
        }
        
        .text-glow {
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }
        
        .event-details {
            font-size: 0.85em;
            opacity: 0.8;
        }
        
        .latency-badge {
            font-size: 0.7em;
            padding: 2px 6px;
        }
        
        .timestamp {
            font-size: 0.75em;
            color: #aaa;
        }
        
        .call-item {
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 5px;
        }
        
        .call-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(3px);
        }
        
        .call-item.selected {
            background: rgba(0, 123, 255, 0.3);
            border: 1px solid rgba(0, 123, 255, 0.5);
        }
        
        .event-filter {
            margin-bottom: 10px;
        }
        
        .severity-success { border-left-color: #28a745 !important; }
        .severity-info { border-left-color: #17a2b8 !important; }
        .severity-warning { border-left-color: #ffc107 !important; }
        .severity-danger { border-left-color: #dc3545 !important; }
        .severity-primary { border-left-color: #007bff !important; }
        
        .connection-id {
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-transparent">
        <div class="container">
            <a class="navbar-brand text-glow" href="#">
                🤖 AgentStream Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <span class="status-indicator status-online" id="connectionStatus"></span>
                    <span id="connectionText">Connected</span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Enhanced Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-2 col-sm-6 mb-3">
                <div class="card glass-card stat-card text-white" 
                     data-bs-toggle="tooltip" 
                     data-bs-placement="top" 
                     title="Total Calls: Number of CONNECTED events received. Each represents a new voice call session initiated through Exotel.">
                    <div class="card-body text-center p-3">
                        <i class="fas fa-phone fa-2x text-success mb-2"></i>
                        <h5 class="card-title" id="totalCalls">0</h5>
                        <small class="card-text">Total Calls</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-6 mb-3">
                <div class="card glass-card stat-card text-white" 
                     data-bs-toggle="tooltip" 
                     data-bs-placement="top" 
                     title="Media Packets: Number of audio chunks processed. Each chunk represents a small segment of voice data (typically 20ms of audio).">
                    <div class="card-body text-center p-3">
                        <i class="fas fa-wave-square fa-2x text-info mb-2"></i>
                        <h5 class="card-title" id="totalMedia">0</h5>
                        <small class="card-text">Media Packets</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-6 mb-3">
                <div class="card glass-card stat-card text-white" 
                     data-bs-toggle="tooltip" 
                     data-bs-placement="top" 
                     title="Total Events: Sum of all processed events (CONNECTED, START, MEDIA, DTMF, MARK, CLEAR, STOP). Shows overall system activity.">
                    <div class="card-body text-center p-3">
                        <i class="fas fa-list fa-2x text-warning mb-2"></i>
                        <h5 class="card-title" id="totalEvents">0</h5>
                        <small class="card-text">Total Events</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-6 mb-3">
                <div class="card glass-card stat-card text-white" 
                     data-bs-toggle="tooltip" 
                     data-bs-placement="top" 
                     title="Average Inter-Event Latency: Average time between consecutive events (DTMF→Media, Media→Media, etc.). Lower values indicate more responsive real-time communication.">
                    <div class="card-body text-center p-3">
                        <i class="fas fa-stopwatch fa-2x text-primary mb-2"></i>
                        <h5 class="card-title" id="avgLatency">0ms</h5>
                        <small class="card-text">Avg Latency</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-6 mb-3">
                <div class="card glass-card stat-card text-white" 
                     data-bs-toggle="tooltip" 
                     data-bs-placement="top" 
                     title="First Media Latency: Time from call start (CONNECTED event) to first audio packet received. This measures how quickly audio begins flowing after connection establishment.">
                    <div class="card-body text-center p-3">
                        <i class="fas fa-play fa-2x text-success mb-2"></i>
                        <h5 class="card-title" id="firstMediaLatency">0ms</h5>
                        <small class="card-text">First Media</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-6 mb-3">
                <div class="card glass-card stat-card text-white" 
                     data-bs-toggle="tooltip" 
                     data-bs-placement="top" 
                     title="End-to-End Latency: Total call duration from CONNECTED event to STOP event. This represents the complete session length from start to finish.">
                    <div class="card-body text-center p-3">
                        <i class="fas fa-route fa-2x text-danger mb-2"></i>
                        <h5 class="card-title" id="endToEndLatency">0ms</h5>
                        <small class="card-text">End-to-End</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Enhanced Live Event Feed -->
            <div class="col-lg-6 mb-4">
                <div class="card glass-card text-white">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" 
                            data-bs-toggle="tooltip" 
                            data-bs-placement="right" 
                            title="Live Event Feed: Real-time stream of events from the Enhanced Echo Bot. Shows conversational flow: 🎧 Buffering → 🤔 Silence Detection → 🗣️ Response → 🛑 Clear Interruption">
                            <i class="fas fa-stream me-2"></i>Live Event Feed
                            <span class="badge bg-primary ms-2" id="eventCount">0</span>
                        </h5>
                        <div>
                            <select class="form-select form-select-sm" id="eventTypeFilter" style="width: auto; display: inline-block;">
                                <option value="">All Events</option>
                                <option value="connected">Connected</option>
                                <option value="start">Start</option>
                                <option value="media">Media</option>
                                <option value="mark">Mark</option>
                                <option value="clear">Clear</option>
                                <option value="dtmf">DTMF</option>
                                <option value="stop">Stop</option>
                            </select>
                            <button class="btn btn-sm btn-outline-light ms-2" onclick="clearEventFeed()">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="eventFeed" class="event-feed">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-satellite-dish fa-2x mb-2"></i>
                                <p>Waiting for events...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Call Sessions & Selection -->
            <div class="col-lg-3 mb-4">
                <div class="card glass-card text-white">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-phone-alt me-2"></i>Call Sessions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="callSessions" class="call-sessions">
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-phone-slash fa-2x mb-2"></i>
                                <p>No active sessions</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Event Type Chart -->
            <div class="col-lg-3 mb-4">
                <div class="card glass-card text-white">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>Event Distribution
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="eventChart" width="250" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Call Details Panel -->
            <div class="col-lg-8 mb-4">
                <div class="card glass-card text-white">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list-ul me-2"></i>Call Details
                            <span id="selectedCallInfo" class="text-muted ms-2">Select a call to view events</span>
                        </h5>
                        <button class="btn btn-sm btn-outline-light" onclick="exportCallData()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="callDetails" class="call-history">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-mouse-pointer fa-2x mb-2"></i>
                                <p>Select a call session to view detailed events and latency data</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Server Management -->
            <div class="col-lg-4 mb-4">
                <div class="card glass-card text-white">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>Server Management
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-6">
                                <h6 data-bs-toggle="tooltip" 
                                   data-bs-placement="left" 
                                   title="Enhanced Echo Server: Conversational AI that listens first (buffers audio), detects silence, then responds naturally. Supports interruption via CLEAR events.">
                                   Echo Server
                                </h6>
                                <span class="status-indicator status-online"></span>
                                <span class="text-success">Enhanced</span>
                            </div>
                            <div class="col-6">
                                <h6 data-bs-toggle="tooltip" 
                                   data-bs-placement="right" 
                                   title="AgentStream Dashboard: Real-time monitoring with multiline log parsing, latency analytics, and interactive event visualization.">
                                   Dashboard
                                </h6>
                                <span class="status-indicator status-online"></span>
                                <span class="text-success">Connected</span>
                            </div>
                        </div>
                        <hr>
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6>Log Files</h6>
                                <small class="text-muted">
                                    📝 voice_bot_echo.log<br>
                                    📋 calls.log
                                </small>
                            </div>
                        </div>
                        <hr>
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6>Quick Actions</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-outline-light" onclick="refreshStats()">
                                        <i class="fas fa-sync"></i> Refresh Data
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="clearAllLogs()">
                                        <i class="fas fa-broom"></i> Clear All Logs
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="exportAllData()">
                                        <i class="fas fa-file-export"></i> Export All Data
                                    </button>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-12">
                                <h6>Latency Metrics</h6>
                                <small id="latencyMetrics" class="text-muted">
                                    Loading metrics...
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Initialize Socket.IO connection
        const socket = io();
        
        // Chart instance
        let eventChart;
        let selectedCallId = null;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            loadInitialData();
            setupEventFiltering();
            
            // Initialize Bootstrap tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });

        // Socket.IO event handlers
        socket.on('connect', function() {
            document.getElementById('connectionStatus').className = 'status-indicator status-online';
            document.getElementById('connectionText').textContent = 'Connected';
        });

        socket.on('disconnect', function() {
            document.getElementById('connectionStatus').className = 'status-indicator status-offline';
            document.getElementById('connectionText').textContent = 'Disconnected';
        });

        socket.on('new_event', function(event) {
            addEventToFeed(event);
            updateEventCount();
            
            // Refresh call sessions if new connection
            if (event.type === 'connected') {
                loadCallSessions();
            }
        });

        socket.on('stats_update', function(stats) {
            updateStatistics(stats);
        });

        socket.on('event_counts_update', function(eventCounts) {
            updateChart(eventCounts);
        });

        socket.on('latency_update', function(latencyData) {
            updateLatencyMetrics(latencyData);
        });

        socket.on('logs_cleared', function() {
            location.reload(); // Refresh the entire dashboard
        });

        // Initialize chart
        function initializeChart() {
            const ctx = document.getElementById('eventChart').getContext('2d');
            eventChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Connected', 'Start', 'Media', 'Mark', 'Clear', 'DTMF', 'Stop'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: [
                            '#28a745', '#007bff', '#17a2b8', '#ffc107', 
                            '#fd7e14', '#6f42c1', '#dc3545'
                        ],
                        borderWidth: 2,
                        borderColor: 'rgba(255, 255, 255, 0.2)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'white',
                                font: { size: 9 }
                            }
                        }
                    }
                }
            });
        }

        // Load initial data
        function loadInitialData() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    updateStatistics(data.live_stats);
                    updateChart(data.event_counts);
                    updateLatencyMetrics(data.live_stats);
                    
                    // Load recent events
                    data.recent_events.forEach(event => addEventToFeed(event));
                    
                    // Load call sessions
                    updateCallSessions(data.call_sessions);
                });
        }

        // Load call sessions
        function loadCallSessions() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    updateCallSessions(data.call_sessions);
                });
        }

        // Update statistics
        function updateStatistics(stats) {
            document.getElementById('totalCalls').textContent = stats.total_calls || 0;
            document.getElementById('totalMedia').textContent = stats.total_media_packets || 0;
            document.getElementById('totalEvents').textContent = stats.total_events || 0;
            document.getElementById('avgLatency').textContent = (stats.avg_latency || 0) + 'ms';
            document.getElementById('firstMediaLatency').textContent = (stats.first_media_latency || 0) + 'ms';
            document.getElementById('endToEndLatency').textContent = (stats.end_to_end_latency || 0) + 'ms';
        }

        // Update latency metrics
        function updateLatencyMetrics(latencyData) {
            const metricsDiv = document.getElementById('latencyMetrics');
            metricsDiv.innerHTML = `
                📈 Avg Inter-Event: ${latencyData.avg_latency || 0}ms<br>
                🚀 First Media: ${latencyData.first_media_latency || 0}ms<br>
                🏁 End-to-End: ${latencyData.end_to_end_latency || 0}ms
            `;
        }

        // Update chart
        function updateChart(eventCounts) {
            const counts = [
                eventCounts.connected || 0,
                eventCounts.start || 0,
                eventCounts.media || 0,
                eventCounts.mark || 0,
                eventCounts.clear || 0,
                eventCounts.dtmf || 0,
                eventCounts.stop || 0
            ];
            
            eventChart.data.datasets[0].data = counts;
            eventChart.update();
        }

        // Update call sessions
        function updateCallSessions(sessions) {
            const sessionsDiv = document.getElementById('callSessions');
            
            if (Object.keys(sessions).length === 0) {
                sessionsDiv.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-phone-slash fa-2x mb-2"></i>
                        <p>No active sessions</p>
                    </div>
                `;
                return;
            }
            
            sessionsDiv.innerHTML = Object.entries(sessions).map(([id, session]) => `
                <div class="call-item ${selectedCallId === id ? 'selected' : ''}" onclick="selectCall('${id}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong class="connection-id">${id}</strong><br>
                            <small class="text-muted">${session.event_count} events</small>
                        </div>
                        <div class="text-end">
                            <small class="text-warning">${session.avg_latency}ms</small><br>
                            <small class="text-muted">${session.start_time ? new Date(session.start_time).toLocaleTimeString() : 'N/A'}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Select call for detailed view
        function selectCall(connectionId) {
            selectedCallId = connectionId;
            document.getElementById('selectedCallInfo').textContent = `Call: ${connectionId}`;
            
            // Update UI to show selection
            document.querySelectorAll('.call-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.call-item').classList.add('selected');
            
            // Load call details
            fetch(`/api/call/${connectionId}`)
                .then(response => response.json())
                .then(data => {
                    updateCallDetails(data);
                })
                .catch(error => {
                    console.error('Error loading call details:', error);
                });
        }

        // Update call details panel
        function updateCallDetails(callData) {
            const detailsDiv = document.getElementById('callDetails');
            
            if (!callData.events || callData.events.length === 0) {
                detailsDiv.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>No events found for this call</p>
                    </div>
                `;
                return;
            }
            
            detailsDiv.innerHTML = callData.events.map((event, index) => {
                // Fix timestamp parsing for call details
                let timestamp;
                if (event.timestamp) {
                    timestamp = new Date(event.timestamp).toLocaleTimeString();
                } else if (event.timestamp_str) {
                    const timeStr = event.timestamp_str.replace(',', '.').replace(' ', 'T');
                    timestamp = new Date(timeStr).toLocaleTimeString();
                } else {
                    timestamp = 'N/A';
                }
                const latencyBadge = event.inter_event_latency_ms > 0 ? 
                    `<span class="badge latency-badge bg-info">+${event.inter_event_latency_ms}ms</span>` : '';
                
                return `
                    <div class="event-item event-${event.type} severity-${event.severity} p-3 mb-2 rounded">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="me-2">${event.icon}</span>
                                    <strong>${event.event}</strong>
                                    ${latencyBadge}
                                    ${event.first_media_latency_ms ? `<span class="badge latency-badge bg-success">First Media: ${event.first_media_latency_ms}ms</span>` : ''}
                                    ${event.end_to_end_latency_ms ? `<span class="badge latency-badge bg-danger">E2E: ${event.end_to_end_latency_ms}ms</span>` : ''}
                                </div>
                                <div class="event-details">
                                    ${event.description}
                                    ${event.connection_id ? `<br><small>Connection: <span class="connection-id">${event.connection_id}</span></small>` : ''}
                                    ${event.stream_sid ? `<br><small>Stream: ${event.stream_sid}</small>` : ''}
                                    ${event.call_sid ? `<br><small>Call: ${event.call_sid}</small>` : ''}
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="timestamp">${timestamp}</div>
                                <small class="text-muted">#${index + 1}</small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Add event to feed with filtering
        function addEventToFeed(event) {
            const feed = document.getElementById('eventFeed');
            const filter = document.getElementById('eventTypeFilter').value;
            
            // Check if event should be displayed based on filter
            if (filter && event.type !== filter) {
                return;
            }
            
            // Remove "waiting" message if present
            if (feed.children.length === 1 && feed.children[0].classList.contains('text-center')) {
                feed.innerHTML = '';
            }
            
            // Fix timestamp parsing
            let timestamp;
            if (event.timestamp_str) {
                // Handle both formats: "2025-07-31 17:00:05,555" and ISO format
                const timeStr = event.timestamp_str.replace(',', '.').replace(' ', 'T');
                timestamp = new Date(timeStr).toLocaleTimeString();
            } else if (event.timestamp) {
                timestamp = new Date(event.timestamp).toLocaleTimeString();
            } else {
                timestamp = new Date().toLocaleTimeString();
            }
            
            const latencyBadge = event.inter_event_latency_ms > 0 ? 
                `<span class="badge latency-badge bg-info ms-2">+${event.inter_event_latency_ms}ms</span>` : '';
            
            const eventElement = document.createElement('div');
            eventElement.className = `event-item event-${event.type} severity-${event.severity || 'info'} p-2 rounded`;
            eventElement.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center">
                            <span class="me-2">${event.icon}</span>
                            <strong>${event.event}</strong>
                            ${latencyBadge}
                        </div>
                        <div class="event-details">
                            ${event.description}
                            ${event.connection_id ? `<br><small class="connection-id">${event.connection_id}</small>` : ''}
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="timestamp">${timestamp}</div>
                    </div>
                </div>
            `;
            
            feed.insertBefore(eventElement, feed.firstChild);
            
            // Keep only last 100 events
            while (feed.children.length > 100) {
                feed.removeChild(feed.lastChild);
            }
        }

        // Setup event filtering
        function setupEventFiltering() {
            document.getElementById('eventTypeFilter').addEventListener('change', function() {
                filterEvents();
            });
        }

        // Filter events based on type
        function filterEvents() {
            const filter = document.getElementById('eventTypeFilter').value;
            const events = document.querySelectorAll('#eventFeed .event-item');
            
            events.forEach(event => {
                if (!filter || event.classList.contains(`event-${filter}`)) {
                    event.style.display = 'block';
                } else {
                    event.style.display = 'none';
                }
            });
        }

        // Utility functions
        function updateEventCount() {
            const eventFeed = document.getElementById('eventFeed');
            const visibleEvents = eventFeed.querySelectorAll('.event-item[style*="display: block"], .event-item:not([style*="display: none"])');
            document.getElementById('eventCount').textContent = visibleEvents.length;
        }

        function clearEventFeed() {
            document.getElementById('eventFeed').innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-satellite-dish fa-2x mb-2"></i>
                    <p>Event feed cleared. Waiting for new events...</p>
                </div>
            `;
            document.getElementById('eventCount').textContent = '0';
        }

        function refreshStats() {
            loadInitialData();
        }

        function clearAllLogs() {
            if (confirm('Are you sure you want to clear all logs? This action cannot be undone.')) {
                fetch('/api/clear_logs', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('All logs cleared successfully!');
                        } else {
                            alert('Error clearing logs: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('Error clearing logs: ' + error);
                    });
            }
        }

        function exportCallData() {
            if (!selectedCallId) {
                alert('Please select a call first');
                return;
            }
            
            fetch(`/api/call/${selectedCallId}`)
                .then(response => response.json())
                .then(data => {
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `call_${selectedCallId}_data.json`;
                    link.click();
                });
        }

        function exportAllData() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `dashboard_export_${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                });
        }

        // Auto-refresh every 30 seconds
        setInterval(function() {
            if (document.visibilityState === 'visible') {
                loadCallSessions();
            }
        }, 30000);
    </script>
</body>
</html> 